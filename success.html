<script>
(async () => {
  const DUR = { '1d': 86400, '7d': 86400*7, '30d': 86400*30 };
  const sid = new URLSearchParams(location.search).get('session_id');
  if (!sid) { console.warn('no session_id'); return; }

  // 決済情報を取得
  const res = await fetch('/.netlify/functions/retrieve-session?session_id=' + encodeURIComponent(sid));
  const json = await res.json().catch(()=>null);
  if (!json) { alert('検証エラー'); return; }

  const paid   = !!json.paid;
  const md     = json.metadata || {};
  const key    = md.cellKey || '';
  const tier   = md.tier || 'normal';
  const period = md.period || '1d';
  const title  = md.title || '（無題）';

  // pending（編集画面で保存しておいた一時データ）を拾う：無ければmetadataだけで保存
  let pending = null;
  try { pending = JSON.parse(sessionStorage.getItem('appicel:pending:' + key) || 'null'); } catch {}

  if (!key) { alert('cellKeyが空です'); return; }
  if (!paid) { alert('未決済のため反映しません'); return; }

  let store = {};
  try { store = JSON.parse(localStorage.getItem('pixelWallFan32') || '{}'); } catch {}

  const data = pending ? {
    t: pending.t || title,
    img: pending.img || '',
    imgData: pending.imgData || null,
    url: pending.url || '',
    desc: pending.desc || '',
    tier: pending.tier || tier,
    createdAt: Date.now(),
    durationSec: pending.durationSec || DUR[period] || DUR['1d']
  } : {
    t: title,
    img: '',
    imgData: null,
    url: '',
    desc: '',
    tier,
    createdAt: Date.now(),
    durationSec: DUR[period] || DUR['1d']
  };

  store[key] = data;
  localStorage.setItem('pixelWallFan32', JSON.stringify(store));
  if (pending) sessionStorage.removeItem('appicel:pending:' + key);
  location.href = '/';
})();
const cellKey = data?.metadata?.cellKey;
if (cellKey) {
  // データ反映
  localStorage.setItem('pixelWallFan32', JSON.stringify({
    ...JSON.parse(localStorage.getItem('pixelWallFan32') || '{}'),
    [cellKey]: {
      t: data.metadata.title || '',
      tier: data.metadata.tier || 'normal',
      period: data.metadata.period || '',
      img: '',
      imgData: null,
      url: '',
      desc: ''
    }
  }));

  // グリッド更新＆視覚エフェクト
  try {
    updateCell && updateCell(cellKey);
    renderGrid && renderGrid();
    const el = document.querySelector(`.cell[data-key="${cellKey}"]`);
    if (el) {
      el.style.transition = 'box-shadow .25s';
      el.style.boxShadow = '0 0 0 3px rgba(220,38,38,.8)';
      setTimeout(() => (el.style.boxShadow = ''), 1200);
    }
  } catch (err) {
    console.warn('セルの自動反映に失敗:', err);
  }
}
</script>


